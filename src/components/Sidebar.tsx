import React, { useState } from 'react';
import { useChatContext } from '../context/ChatContext';
import { PlusCircle, MessageSquare, Trash2, Edit2, X, Settings } from 'lucide-react';
import SettingsModal from './SettingsModal';

interface SidebarProps {
  onClose: () => void;
}

const Sidebar: React.FC<SidebarProps> = ({ onClose }) => {
  const { 
    conversations, 
    currentConversationId, 
    createNewConversation, 
    setCurrentConversationId,
    deleteConversation,
    updateConversationTitle
  } = useChatContext();
  
  const [editingId, setEditingId] = useState<string | null>(null);
  const [editTitle, setEditTitle] = useState<string>('');
  const [showSettingsModal, setShowSettingsModal] = useState(false);

  const handleEdit = (id: string, currentTitle: string) => {
    setEditingId(id);
    setEditTitle(currentTitle);
  };

  const handleSaveEdit = (id: string) => {
    if (editTitle.trim()) {
      updateConversationTitle(id, editTitle.trim());
    }
    setEditingId(null);
  };

  const handleKeyDown = (e: React.KeyboardEvent, id: string) => {
    if (e.key === 'Enter') {
      handleSaveEdit(id);
    }
  };

  const formatDate = (timestamp: number) => {
    const date = new Date(timestamp);
    return date.toLocaleDateString();
  };

  const sortedConversations = [...conversations].sort((a, b) => b.updatedAt - a.updatedAt);

  return (
    <div className="flex flex-col h-full bg-white dark:bg-black text-black dark:text-white">
      <div className="p-4 border-b border-gray-200 dark:border-gray-800 flex items-center justify-between">
        <div className="flex items-center space-x-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 375 375" className="text-black dark:text-white">
            <path
              fill="currentColor"
              d="M219.652344 212.25c-.550782.710938-1.121094 1.410156-1.710938 2.097656-.589844.683594-1.195312 1.351562-1.816406 2.003906-.621094.65625-1.261719 1.292969-1.914062 1.914062-.65625.621094-1.328126 1.222657-2.011719 1.808594-.6875.585937-1.386719 1.15625-2.101563 1.707031-.71875.550782-1.445312 1.082032-2.1875 1.59375-.742187.515625-1.496094 1.007813-2.265625 1.480469-.765625.476563-1.546875.929688-2.335937 1.363282-.792969.433593-1.59375.847656-2.40625 1.242187-.8125.390625-1.632813.765625-2.464844 1.113281-.832031.351563-1.671875.683594-2.519531.988282-.847657.308593-1.703125.59375-2.566407.859374-.859374.265626-1.730468.503907-2.605468.722657-.875.222656-1.753906.417969-2.640625.59375-.882813.171875-1.773438.324219-2.664063.453125-.894531.128906-1.789062.234375-2.6875.316406-.898437.082031-1.796875.140625-2.699218.175781-.902344.039063-1.800782.050782-2.703125.042969-.902344-.011719-1.804688-.042969-2.703125-.101563-.902344-.054687-1.800782-.136718-2.695313-.238281-.898437-.101562-1.789062-.226562-2.679687-.375-.890625-.148437-1.773438-.320312-2.65625-.511718-.878906-.195313-1.757813-.410157-2.625-.648438-.871094-.238281-1.734375-.5-2.589844-.78125-.859375-.285156-1.707031-.589844-2.546875-.914062-.839844-.328125-1.671875-.675782-2.496094-1.042969-.824219-.371094-1.636719-.761719-2.441406-1.171875-.800781-.410156-1.59375-.84375-2.375-1.292969-.78125-.453125-1.550781-.921875-2.308594-1.414062-.753906-.492188-1.5-.996094-2.230469-1.53125-.730468-.527344-1.449218-1.078125-2.152343-1.644532-.699219-.5625-1.390625-1.148437-2.0625-1.75-.671875-.601562-1.328125-1.21875-1.96875-1.855468-.644531-.632813-1.269531-1.285156-1.875-1.953125-.609375-.664063-1.199219-1.347656-1.773437-2.046875-.570313-.695313-1.125-1.40625-1.664063-2.132813-.535156-.726562-1.054687-1.464843-1.550781-2.21875-.5-.753906-.980469-1.515625-1.4375-2.292968-.460937-.777344-.898437-1.566406-1.320312-2.367188-.417969-.800781-.816407-1.609375-1.195313-2.429687-.375-.820313-.734375-1.648438-1.070312-2.488281-.332031-.835938-.648438-1.683594-.9375-2.539063-.292969-.855469-.5625-1.714844-.8125-2.585937-.246094-.867188-.472656-1.742188-.675781-2.621094-.203125-.878906-.382813-1.765625-.539063-2.652344-.160156-.890625-.292968-1.78125-.40625-2.679687-.113281-.894532-.199219-1.792969-.265625-2.695313-.066406-.898437-.109375-1.800781-.128906-2.703125-.019531-.90625-.019531-1.808594.007813-2.710937.027343-.902344.078125-1.804688.148437-2.703125.074219-.902344.167969-1.796875.285156-2.695313.121094-.894531.261719-1.785156.425781-2.671875.164063-.890625.351563-1.773437.558594-2.652343.210937-.878907.441406-1.75.695313-2.617188.253906-.867188.53125-1.726562.828124-2.578125.300782-.851563.617188-1.695313.960938-2.53125.339844-.835938.703125-1.664063 1.085938-2.480469.382812-.820312.789062-1.625 1.214843-2.421875.421875-.796875.867188-1.582031 1.332031-2.355469.464844-.773437.953126-1.535156 1.457032-2.285156.503906-.75 1.023437-1.484375 1.566406-2.207031.542969-.722656 1.101562-1.429688 1.679688-2.121094.578124-.695313 1.175781-1.371094 1.785156-2.035156.613281-.664063 1.242187-1.308594 1.890625-1.941407.644531-.628906 1.304687-1.242187 1.984375-1.839843.679687-.59375 1.371094-1.175782 2.078125-1.734376.707031-.5625 1.429687-1.105468 2.164062-1.628906.734375-.523437 1.480469-1.027344 2.242188-1.515625.761719-.484375 1.53125-.949219 2.316406-1.394531.785156-.445313 1.578125-.871094 2.386719-1.277344.804687-.40625 1.621094-.789062 2.445312-1.152344.828125-.363281 1.660157-.707031 2.503907-1.027343.84375-.320313 1.695312-.617188 2.554687-.894532.859375-.277343 1.722656-.53125 2.59375-.761718.871094-.234375 1.75-.445313 2.632813-.632813.882812-.183593 1.769531-.351562 2.660156-.492187.890625-.140625 1.785156-.261719 2.679687-.355469.898438-.097656 1.796876-.167969 2.695313-.21875.902344-.050781 1.804687-.078125 2.703125-.078125.902344-.003906 1.804688.015625 2.707031.058594.898438.042969 1.800782.105469 2.695313.195312.898437.089844 1.792969.203125 2.6875.335938.890625.136719 1.777344.292969 2.660156.472656.886719.179688 1.765625.382813 2.636719.609375.875.226563 1.742188.472656 2.601562.742188.859375.273437 1.714844.5625 2.558594.878906.847656.3125 1.683594.648437 2.511719 1.003906.828125.359375 1.648437.734375 2.457031 1.132813.808594.402343 1.609375.820312 2.394531 1.261718.789063.4375 1.566407.898438 2.328125 1.378906.765625.480469 1.515625.976563 2.253906 1.496094.738282.519532 1.464844 1.054688 2.175782 1.609375.710937.554688 1.40625 1.128907 2.089843 1.722657.683594.589843 1.347657 1.199218 2 1.824218.648438.625 1.285157 1.265625 1.902344 1.925782.617187.65625 1.21875 1.332031 1.800781 2.019531 L 227.089844 138.625c-1.5-1.796875-3.089844-3.503906-4.777344-5.121094-1.6875-1.621094-3.457031-3.144531-5.308594-4.570312-1.851562-1.421875-3.777344-2.742188-5.773437-3.957032-1.996094-1.214843-4.054688-2.316406-6.171875-3.308593-2.117188-.988281-4.28125-1.859375-6.492188-2.609375-2.214844-.75-4.460937-1.378906-6.742187-1.886719-2.28125-.503906-4.582031-.882813-6.90625-1.136719-2.320313-.253906-4.652344-.378906-6.988281-.375-35.421876 0-64.144532 28.757813-64.144532 64.230469 0 35.472656 28.722656 64.230469 64.144532 64.230469 2.433593 0 4.859374-.136719 7.277343-.410156 2.417969-.273438 4.8125-.683594 7.183594-1.234375 2.371093-.546875 4.707031-1.226563 7-2.042969 2.292969-.8125 4.53125-1.753906 6.71875-2.824219 2.1875-1.070312 4.304687-2.261719 6.355468-3.574219 2.050782-1.3125 4.019532-2.734374 5.910157-4.273437 1.886719-1.535156 3.683593-3.175781 5.382812-4.914063 1.703125-1.742187 3.300781-3.578124 4.792969-5.5 z m -3.496094 -38.652344c.203125 1.472656.335937 2.953125.398437 4.4375.058594 1.484375.046875 2.96875-.035156 4.453125-.085938 1.484375-.242188 2.960938-.472656 4.429688-.230469 1.46875-.53125 2.921875-.90625 4.363281-.371094 1.4375-.8125 2.855469-1.324219 4.25-.511719 1.394531-1.089844 2.761719-1.734375 4.101562-.648438 1.339844-1.355469 2.640625-2.128906 3.910157-.773438 1.269531-1.609375 2.496093-2.503906 3.683593-.894532 1.1875-1.84375 2.328125-2.847657 3.421875-1.007812 1.09375-2.066406 2.132813-3.171875 3.121094-1.109375.992187-2.261718 1.921875-3.460937 2.800781-1.203125.875-2.441407 1.6875-3.71875 2.441406-1.28125.753907-2.59375 1.445313-3.941407 2.070313-1.347656.625-2.722656 1.179687-4.125 1.671875-1.402343.488281-2.824218.90625-4.265624 1.257812-1.445313.347657-2.902344.625-4.371094.832031-1.46875.207032-2.945313.339844-4.429688.398438-1.484375.0625-2.96875.050781-4.449218-.035156-1.480469-.085938-2.957032-.242188-4.421875-.472656-1.46875-.230469-2.921875-.53125-4.355469-.902344-1.4375-.375-2.855469-.816406-4.25-1.328125-1.390625-.511719-2.757812-1.09375-4.09375-1.738281-1.335938-.648438-2.640625-1.359375-3.90625-2.132813-1.265625-.773437-2.492188-1.609375-3.679688-2.503906-1.183594-.894531-2.324218-1.847656-3.414062-2.855469-1.09375-1.007812-2.132812-2.066406-3.121094-3.175781-.988281-1.109375-1.917968-2.265625-2.792968-3.464844-.875-1.203125-1.6875-2.441406-2.441406-3.722656-.753907-1.28125-1.441407-2.597656-2.066407-3.945313-.621093-1.351562-1.179687-2.726562-1.667969-4.128906-.488281-1.40625-.90625-2.828125-1.253906-4.273437-.347656-1.445313-.625-2.90625-.832031-4.375-.207031-1.46875-.339844-2.949219-.398437-4.433594-.058594-1.484375-.046876-2.972656.035156-4.457031.085937-1.480469.242187-2.957031.472656-4.425781.230469-1.46875.53125-2.925782.90625-4.363282.371094-1.4375.8125-2.855468 1.324219-4.25.511718-1.398437 1.089843-2.765625 1.734375-4.101562.648437-1.339844 1.355468-2.644532 2.128906-3.914062.773437-1.265626 1.609375-2.496094 2.503906-3.683594.894531-1.183594 1.84375-2.324219 2.847656-3.417969 1.007813-1.09375 2.066406-2.136719 3.171875-3.125 1.109375-.988281 2.261719-1.921875 3.460938-2.796875 1.203125-.875 2.441406-1.691406 3.71875-2.445312 1.28125-.753907 2.59375-1.441407 3.941406-2.066407 1.347656-.625 2.722656-1.183593 4.125-1.671875 1.402344-.488281 2.824219-.910156 4.265625-1.261718 1.445313-.347657 2.902344-.628907 4.371094-.832032 1.46875-.207031 2.945312-.339844 4.429687-.402344 1.484375-.058593 2.96875-.046874 4.449219.035157 1.480469.085937 2.957031.246093 4.421875.476562 1.46875.226563 2.921875.527344 4.355469.902344 1.4375.375 2.855469.816406 4.25 1.328125 1.394531.511719 2.761719 1.089844 4.097656 1.738281 1.335937.644532 2.640625 1.355469 3.90625 2.132813 1.265625.773437 2.492187 1.609375 3.679687 2.503906 1.183594.894531 2.324219 1.847656 3.414063 2.855469 1.09375 1.003906 2.132812 2.0625 3.121094 3.171875.988281 1.109375 1.917968 2.265625 2.792968 3.464844.875 1.199218 1.6875 2.441406 2.441406 3.722656.753907 1.28125 1.441407 2.597656 2.066407 3.945312.621093 1.347656 1.179687 2.726563 1.667969 4.128907.488281 1.402343.90625 2.828125 1.253906 4.273437.347656 1.445313.625 2.902344.832031 4.375 z m 0 0"
            />
          </svg>
          <h1 className="text-xl font-semibold">B.H.I.M.A</h1>
        </div>
        <div className="flex items-center space-x-2">
          <button
            onClick={() => setShowSettingsModal(true)}
            className="p-2 rounded-md text-black dark:text-white hover:bg-gradient-to-r hover:from-blue-600 hover:to-purple-600 hover:text-white transition-colors"
          >
            <Settings size={20} />
          </button>
          <button
            className="md:hidden p-2 rounded-md text-black dark:text-white hover:bg-gradient-to-r hover:from-blue-600 hover:to-purple-600 hover:text-white transition-colors"
            onClick={onClose}
          >
            <X size={20} />
          </button>
        </div>
      </div>

      <button
        onClick={() => createNewConversation()}
        className="mx-4 mt-4 mb-2 py-2 px-4 text-white bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 rounded-md flex items-center space-x-2 transition-all"
      >
        <PlusCircle size={18} />
        <span>New chat</span>
      </button>

      <div className="flex-1 overflow-y-auto pt-2">
        <h2 className="px-4 mb-2 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
          Conversations
        </h2>
        
        <ul className="space-y-1 px-2">
          {sortedConversations.length === 0 ? (
            <li className="px-2 py-3 text-sm text-gray-500 dark:text-gray-400">No conversations yet</li>
          ) : (
            sortedConversations.map((conv) => (
              <li
                key={conv.id}
                className={`relative group ${
                  currentConversationId === conv.id
                    ? 'bg-gradient-to-r from-blue-600/10 to-purple-600/10 dark:from-blue-600/20 dark:to-purple-600/20'
                    : 'hover:bg-gradient-to-r hover:from-blue-600/5 hover:to-purple-600/5 dark:hover:from-blue-600/10 dark:hover:to-purple-600/10'
                } transition-all`}
              >
                {editingId === conv.id ? (
                  <div className="p-2 flex">
                    <input
                      type="text"
                      value={editTitle}
                      onChange={(e) => setEditTitle(e.target.value)}
                      onBlur={() => handleSaveEdit(conv.id)}
                      onKeyDown={(e) => handleKeyDown(e, conv.id)}
                      className="flex-1 min-w-0 px-2 py-1 text-sm rounded border border-gray-200 dark:border-gray-800 focus:outline-none focus:ring-1 focus:ring-black dark:focus:ring-white"
                      autoFocus
                    />
                  </div>
                ) : (
                  <div 
                    className="p-2 cursor-pointer flex items-start group"
                    onClick={() => setCurrentConversationId(conv.id)}
                  >
                    <MessageSquare className="flex-shrink-0 h-5 w-5 mt-0.5 mr-3 text-gray-500 dark:text-gray-400" />
                    <div className="flex-1 min-w-0">
                      <p className="text-sm font-medium truncate">{conv.title}</p>
                      <p className="text-xs text-gray-500 dark:text-gray-400">{formatDate(conv.updatedAt)}</p>
                    </div>
                    <div className="ml-2 flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity">
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          handleEdit(conv.id, conv.title);
                        }}
                        className="p-1 text-gray-500 dark:text-gray-400 hover:text-white hover:bg-gradient-to-r hover:from-blue-600 hover:to-purple-600 rounded transition-all"
                      >
                        <Edit2 size={14} />
                      </button>
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          deleteConversation(conv.id);
                        }}
                        className="p-1 text-gray-500 dark:text-gray-400 hover:text-white hover:bg-gradient-to-r hover:from-red-600 hover:to-red-700 rounded transition-all"
                      >
                        <Trash2 size={14} />
                      </button>
                    </div>
                  </div>
                )}
              </li>
            ))
          )}
        </ul>
      </div>

      <div className="p-4 text-xs text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-gray-800">
        <span className="bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
          B.H.I.M.A v0.1.0
        </span>
      </div>

      {/* Settings Modal */}
      <SettingsModal 
        isOpen={showSettingsModal}
        onClose={() => setShowSettingsModal(false)}
      />
    </div>
  );
};

export default Sidebar;